{% extends "base.tmpl" %}

{% set page_class = 'visit-archive' %}

{% block class %}
 class="{{page_class}}" 
{% endblock %}

{% block content %}
<h1>Tuesday Nighters Archive {{viewyear|escape}} {{monthname|escape}}</h1>
{% if viewyear == ''%}
<article class="intro__text"><b>All Time Visit Stats</b></article>
<table class="flexitable">
        <tr>
                <th>Attempts</th>
                <th>Rainedoff</th>
                <th>Visited</th>
                <th>% Visited</th>
                <th>% Rainedoff</th>
        </tr>
        {% for s in allsummary %}
        <tr>
                <td data-th="Name">{{ s.attempts|escape }}</td>
                <td data-th="Visits">{{ s.rainedoff|escape }}</td>
                <td data-th="Attempts">{{ s.actual|escape }}</td>
                <td data-th="Visits">{{ s.percentvisited|escape }}%</td>
                <td data-th="Visits">{{ s.percentraindedoff|escape }}%</td>
        </tr>
        {% endfor %}
</table>
{% endif %}
<article class="intro__text">Choose the year you want to view</article>
<table class="cragattendance flexitable">
	<tr>
		<th scope="row" class="visit" valign="middle">Years Available</th>
		{% for y in years %}
		<th>
		<td><a href="visitarchive.php?year={{y.year}}">{{y.year}}</a></td>
		</th>
		{% endfor %}
		</tr>
</table>
<hr/>
{% if viewyear != '' %}
<h3>Visit Stats {{viewyear|escape}}</h3>
<table class="flexitable">
        <tr>
                <th>Attempted visits</th>
                <th>Rainedoff</th>
                <th>Successful visits</th>
                <th>Successful visits %</th>
                <th>Rained off %</th>
        </tr>
        {% for y in yearstats %}
        <tr>
                <td data-th="Name">{{ y.attempts }}</td>
                <td data-th="Visits"><a href="cragstats.php?year={{viewyear}}&#rain">{{ y.rainedoff }}</a></td>
                <td data-th="Visits">{{ y.actual }}</td>
                <td data-th="Visits">{{ y.percentvisited }}%</td>
                <td data-th="Visits">{{ y.percentraindedoff }}%</td>
        </tr>
        {% endfor %}
</table>
{% endif %}
{% if viewyear != '' %}
<table class="cragattendance flexitable">
	<tr>
		<th scope="row" class="visit" valign="middle">
			View full stats for: <a href="cragstats.php?year={{viewyear}}"><b>{{viewyear}}</b></a>
		</th>
	</tr>
	{% if showlink == 1 %}
	<tr>
		<th scope="row" class="visit" valign="middle">
			End of term report: <a href="visitarchive.php?year={{viewyear}}&showreport={{showreport1}}"><b>{{tag}}</b></a> 
		</th>
	</tr>
	{% endif %}
</table>
{% if showreport == 1 %}
<article class="intro__text">
{{termreport|raw}}<br/>
<a href="visitarchive.php?showreport=0&year={{viewyear}}">hide</a><br/><br/>
</article>
{% endif %}

<table class="cragattendance flexitable">
<tr>
<th scope="row" class="visit" valign="middle">Months available<br/>See where and who was there</th>
{% for mon in months %}
<th>
<td><a href="visitarchive.php?month={{mon.monthnum}}&year={{viewyear}}">{{mon.monthname|escape}}</a></td>
</th>
{% endfor %}
</tr>
</table>
{% if viewmonth != '' %}
<table class="cragattendance flexitable">
	<tr>
		<th scope="row" class="visit" valign="middle">Visit</th>
		{% for d in data %}
		<th>
			<a href="/craglogger/dashboard/cragdetail.php?cragvisit_id={{d.cragvisit_id}}">{{ d.venue|escape }} {{d.area}}</a>
			<br/>
			{{ d.date|date("d F Y") }}
			<br/>
			<small>{{ d.event }}</small>
			{% if d.rainedoff == 1 %}
                        <small>Rain stop play</small>
                        {% endif %}
		</th>
		{% endfor %}
	</tr>
	{% for m in member %}
	<tr>
		<td data-th="Cragger" class="cragger">{{ m.firstname }} {{m.surname}}</td>
		{% for d in data %}
			{% set has_attended_this_crag = 0 %}
			{% for a in attended %}
				{% if a.user_id == m.user_id and a.cragvisit_id == d.cragvisit_id %}
					{% set has_attended_this_crag = 1 %}
				{% endif %}
			{% endfor %}
			<td data-th="{{ d.venue|escape }} {{d.area}} - {{ d.date|date("d M Y") }} - {{ d.rock }}">
				{% if has_attended_this_crag == 1 %}
					<span class="yes">YES</span>
				{% else %}
					<span class="no">NO</span>
				{% endif %}
			</td>
		{% endfor %}
	</tr>
	{% endfor %}
</table>
{% endif %}
{% endif %}
{% endblock %}
